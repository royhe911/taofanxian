<include file="Layout:meta" />
<include file="Layout:head" />
<include file="Layout:nav" />
<div class="left" style="width: 1040px;overflow: hidden;background-color: #ffffff;margin: 0 0 8px 10px;">
	<img src="__PUBLIC__/maoke/images/merchant/release_header_show.png" alt="">
</div>
<!-- 发布优惠券2 -->
<div id="my_main" class="store_content left" style="min-height: 1067px;">
	<h1 class="title">上传优惠券</h1>
	<!--2.设置商品搜索-->
	<form action="{:U('Coupon/publish2')}" method="POST" id="myform" />
	<div class="settings_search">
		<h2 class="title">3.设置商品搜索</h2>
		<div class="search_content">
			<div class="by_taobao search_active" data-toggle="search">设置试客从<span>手机淘宝APP</span>找商品</div>
			<div class="taobao_content" style="display: none;">
				<div class="goods_picture">
					<h2>请上传<b>"商品的手机淘宝搜索主图"</b>，以便试客快速找到任务商品：</h2>
					<div id="iphone_tb_a">
						<div class="up_img" onclick="upd_file(this,'img_app');">
							<input type="file" name="img_app" class="fileToUpload" id="img_app" data-img="..{$goods.img2}" accept="image/*" />
							<input type="hidden" id="my_img_app" name="img" value="{$goods.img2}" />
							<empty name="goods.img2">
								<img id="img_app_tb" class="imgList img" src="__PUBLIC__/maoke/images/merchant/sk_zjgl_lqxd_icon_jiahao_default.png">
								<else />
								<img id="img_app_tb" class="imgList img" src="..{$goods.img2}">
							</empty>

							<div class="displayValue" style="word-spacing: normal;word-wrap: break-word;"></div>
						</div>
						<i class="img_tips icon iconfont" id="m_app_tb_img_error"></i>
					</div>
					<p class="xing" style="font-size: 12px;color: #646464; margin-top:10px;">需要上传的是在手机APP进行搜索，搜索页面所展示的搜索主图，图片尺寸为：<b>800*800</b>,格式为：<b>jpg、png、jpeg、gif</b>，图片大小在<b>1M以内</b></p>
				</div>
				<!--************************手机淘宝APP搜索关键词 --页面默认有的**************************-->
				<div class="goods_keywords">
					<h2 <eq name='goods.qudao' value='1'>class="actived"</eq>>通过<b>"手机淘宝APP自然搜索"</b>找到商品<i class="icon iconfont icon-cuowu error hided" id="no_choose_tips" style="display:none;">请至少选择淘口令或者自然搜索其中一种方案找商品</i></h2>
				</div>
				<div class="goods_keywords_pannel hided ">
					<i id="focus2"></i>
					<ul id="search_keyword_box_taobao">
						<empty name="goods.keyword">
							<li class="search_keyword_box box_1">
								<div class="search_keyword">
									<div class="keyword_title">
										<span>*</span>
										<label for="keyword_box">搜索关键词 <i class="number_btn_app">1</i>：</label>
										<input class="keywords mykeywordsapp" type="text" placeholder="连衣裙" name="keyword[]" />
										<b>注：让试客在手机淘宝APP进行搜索的关键词</b><span class="keywords_error"></span>
									</div>
								</div>
							</li>
							<else />
							<volist name="goods.keyword" id="vo" key="k">
								<li class="search_keyword_box box_1">
									<div class="search_keyword">
										<div class="keyword_title">
											<span>*</span>
											<label for="keyword_box">搜索关键词 <i class="number_btn_app">{$k}</i>：</label>
											<input class="keywords mykeywordsapp" name="keyword[]" value="{$vo}" type="text" placeholder="连衣裙">
											<b>注：让试客在手机淘宝APP进行搜索的关键词</b><span class="keywords_error"></span>
										</div>
									</div>
								</li>
							</volist>
						</empty>
						<li id="my_app_li" style="display:none;">xxx</li>
					</ul>
					<!--淘宝APP关键字(复制)start-->
					<div id="my_app_keyword" style="display:none;">
						<li class="search_keyword_box box_1">
							<div class="search_keyword">
								<div class="keyword_title">
									<span>*</span>
									<label for="keyword_box">搜索关键词 <i class="number_btn_app">1</i>：</label>
									<input class="keywords mykeywordsapp" name="keyword[]" type="text" placeholder="连衣裙">
									<b>注：让试客在手机淘宝APP进行搜索的关键词</b><span class="keywords_error"></span>
								</div>
								<p class="add_box">
									<span class="right select_btn2" href="#">删除</span>
								</p>
							</div>
						</li>
					</div>
					<!--淘宝APP关键字(复制)end-->
					<p class="add_search_keyword  ">
						<a id="add_search_keyword_taobao" href="javascript:void(0);">可多添加1个淘宝搜索关键词方案</a>
						<b>最多可添加5组关键词方案</b>
					</p>
				</div>
				<!-- 手机淘口令 -->
				<div class="goods_taokouling">
					<h2 <eq name='goods.qudao' value='2'>class="actived"</eq>>通过<b>"手机淘宝APP淘口令"</b>找到商品 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-size: 12px;color: #646464;"></span></h2>
				</div>
				<div class="goods_taokouling_pannel hided">
					<div class="taokouling_pannel clearfix">
						<empty name="goods.password">
							<div class="taokouling_box left">
								<p><span class="title left">淘口令<span class="taokouling_num">1</span>：<i class="icon iconfont icon-cuowu error hided">淘口令不能为空</i></span>
								</p>
								<textarea class="iphone_tb_command" name="password[]" cols="15" rows="10" style="resize: none;"></textarea>
							</div>
							<else />
							<volist name="goods.password" id="vo" key="k">
								<div class="taokouling_box left">
									<p>
										<span class="title left">淘口令<span class="taokouling_num">{$k}</span>：<i class="icon iconfont icon-cuowu error hided">淘口令不能为空</i>
										</span>
										<s class="detele right <if condition='($k eq 1)'>hided</if>">删除</s>
									</p>
									<textarea class="iphone_tb_command" name="password[]" cols="15" rows="10" style="resize: none;">{$vo}</textarea>
								</div>
							</volist>
						</empty>
						<!--淘口令(复制项)-->
						<div class="mypd" style="display:none;">
							<div class="taokouling_box left">
								<p>
									<span class="title left">淘口令<span class="taokouling_num">1</span>：<i class="icon iconfont icon-cuowu error hided">淘口令不能为空</i>
									</span>
									<s class="detele right">删除</s>
								</p>
								<textarea class="iphone_tb_command" name="password[]" cols="15" rows="10" style="resize: none;"></textarea>
							</div>
						</div>
						<!--淘口令(复制项)end-->
					</div>
					<p class="add_search_taokouling  ">
						<a id="add_search_taokouling" href="javascript:void(0);">可多添加1个淘宝淘口令方案</a>
						<b>最多可添加5组淘口令方案</b>
					</p>
				</div>
			</div>
		</div>
		<div class="nextStep_btn">
			<input onclick="location.href='{:U(\'Coupon/publish1\',array(\'id\' => $id))}'" type="button" value="上一步">
			<input type="hidden" id="type" name="type" value="{$goods.qudao}" />
			<input type="hidden" id="id" name="id" value="{$id}" />
			<!--<input type="button" value="下一步" onclick="next_step();" />-->
			<input type="button" value="下一步"  onclick="next_step();"/>
		</div>
	</div>
	</form>
</div>
</div>
</div>
</section>
<!-- page-wrapper end -->
</div>
<!-- wrapper -->
</div>
<script type="text/javascript">
	$(function() {
		if($(".by_PCtaobao").hasClass("search_active")) {
			$(".taobao_PCcontent").slideToggle("slow");
		}
		if($(".by_taobao").hasClass("search_active")) {
			$(".taobao_content").slideToggle("slow");
			if($(".goods_keywords>h2").hasClass('actived')) {
				$(".goods_keywords_pannel").slideToggle("slow");
			}
			if($(".goods_taokouling>h2").hasClass('actived')) {
				$(".goods_taokouling_pannel").slideToggle("slow");
			}
		}

		$(".by_PCtaobao,.by_taobao").click(function() {
			if(($(this).attr('class')).indexOf('by_PCtaobao') >= 0) {
				if($(this).hasClass("search_active")) {
					$(this).removeClass("search_active");
				} else {
					$(this).addClass("search_active");
				}
				$(".taobao_PCcontent").slideToggle("slow");
			} else if(($(this).attr('class')).indexOf('by_taobao') >= 0) {
				if($(this).hasClass("search_active")) {
					$(this).removeClass("search_active");
				} else {
					$(this).addClass("search_active");
				}
				$(".taobao_content").slideToggle("slow");
			}

		});
		$(".goods_keywords>h2,.goods_taokouling>h2").click(function() {
			if(($(this).parent().attr('class')).indexOf('goods_keywords') >= 0) {
				if($(this).hasClass("actived")) {
					$(this).removeClass("actived");
				} else {
					$(this).addClass("actived");
					$('#type').val(1);
				}
			} else if(($(this).parent().attr('class')).indexOf('goods_taokouling') >= 0) {
				if($(this).hasClass("actived")) {
					$(this).removeClass("actived");
				} else {
					$(this).addClass("actived");
					$('#type').val(2);
				}
			}

		});
		$(".taobao_PCcontent .fold,.taobao_content .fold").click(function() {
			$(this).parent("p").next(".keyword_write").slideToggle("slow");
		});
		$(".taobao_PCcontent .close_btn,.taobao_content .close_btn").click(function() {
			$(this).parents(".keyword_write").slideToggle("slow");
		});

		//pc淘宝自然搜索 添加关键字
		$("#add_search_keyword").click(function() {

			var n = $("#search_keyword_box").children("li").length;
			if(n < 6 && n > 1) {
				var $keywordbox = $("#my_pc_keyword").children("li").clone(true);
				$("#my_pc_li").before($keywordbox);
				$('.number_btn_pc').eq(n - 1).html(n);
			}
			if($("#search_keyword_box>li").length >= 6) {
				$(this).hide();
			}
		});
		//pc淘宝自然搜索 删除关键字
		$(".select_btn1").click(function() {
			$(this).parents(".search_keyword_box").remove();
			if($("#search_keyword_box>li").length < 5) {
				$("#add_search_keyword").show();
			}
		});
		//手机淘宝APP 添加关键字
		$("#add_search_keyword_taobao").click(function() {

			var n = $("#search_keyword_box_taobao").children("li").length;
			if(n < 6 && n > 1) {
				var $keywordbox = $("#my_app_keyword").children("li").clone(true);
				$("#my_app_li").before($keywordbox);
				$('.number_btn_app').eq(n - 1).html(n);
			}
			if($("#search_keyword_box_taobao").children("li").length >= 6) {
				$(this).hide();
			}
		});
		//手机淘宝APP 删除关键字
		$(".taobao_content .select_btn2").click(function() {
			$(this).parents(".search_keyword_box").remove();
			if($("#search_keyword_box_taobao").length < 5) {
				$("#add_search_keyword_taobao").show();
			}
		});
		//淘口令 添加
		$("#add_search_taokouling").click(function() {

			if($(this).parent("p").prev(".taokouling_pannel").children(".taokouling_box").length < 5) {
				var $taokouling = $(".mypd").children(".taokouling_box").clone(true);
				var n = $(this).parent("p").prev(".taokouling_pannel").children(".taokouling_box").length;
				$(".mypd").before($taokouling);
				$(".taokouling_num").eq(n).html(n + 1);
			}
			if($(this).parent("p").prev(".taokouling_pannel").children(".taokouling_box").length == 5) {
				$(this).hide();
			}
		});
		//淘口令 删除
		$(".detele").click(function() {
			$(this).parents(".taokouling_box").remove();
			if($(this).parents(".taokouling_pannel").children(".taokouling_box").length < 5) {
				$("#add_search_taokouling").show();
			}
		});

		$(".goods_keywords").click(function() {
			$(this).next(".goods_keywords_pannel").slideToggle("slow");
		});
		$(".goods_taokouling").click(function() {
			$(this).next(".goods_taokouling_pannel").slideToggle("slow");
		})
	})

	function upd_file(obj, file_id) {
		$("input[name='" + file_id + "']").bind("change", function() {
			$.ajaxFileUpload({
				url: "{:U('Actcenter/AjaxUpload')}", //上传图片处理文件
				secureuri: false,
				fileElementId: file_id,
				dataType: 'text',
				success: function(data) {
					var data = strToObj(data);
					if(1 == data.status) {
						$('#my_' + file_id).val(data.url);
						$('#' + file_id + '_tb').attr('src', '../' + data.url);
						if(file_id == 'img_pc') {
							$("#img_pc_tb_error").text('上传成功').css({
								'display': 'inline-block',
								'color': 'green'
							});
						} else if(file_id == 'img_app') {
							$("#m_app_tb_img_error").text('上传成功').css({
								'display': 'inline-block',
								'color': 'green'
							});
						}
					} else {
						if(file_id == 'img_pc') {
							$("#img_pc_tb_error").text(data.msg).css({
								'display': 'inline-block',
								'color': '#e61e28'
							});
							showSearch('focus1');

						} else if(file_id == 'img_app') {
							$("#m_app_tb_img_error").text(data.msg).css({
								'display': 'inline-block',
								'color': '#e61e28'
							});
							showSearch('focus2');

						}

					}
				},
				error: function(data) {
					var data = strToObj(data);
					if(file_id == 'img_pc') {
						$("#img_pc_tb_error").text(data.msg).css({
							'display': 'inline-block',
							'color': '#e61e28'
						});
						showSearch('focus1');

					} else if(file_id == 'img_app') {
						$("#m_app_tb_img_error").text(data.msg).css({
							'display': 'inline-block',
							'color': '#e61e28'
						});
						showSearch('focus2');

					}
				}
			});
		});
	}
	function strToObj(str) {
		return eval("(" + str + ")");
	}

	function showSearch(id) {
		var oDiv = $("#" + id);
		var t = document.createElement("input");
		t.type = "text";
		oDiv.prepend(t);
		t.focus();
		t.remove();
	}

	function next_step() {
		if($(".by_PCtaobao").hasClass('search_active')) {
			//      		var imgPc = $("#img_pc").val(); //pc端上传图片
			var imgPc = $("#img_pc_tb").attr('src'); //pc端上传图片
			var isUpload = $("#img_pc").data('img');
			if(imgPc.indexOf('maoke') > 0 && isUpload == '..') {
				$("#img_pc_tb_error").text('请上传图片').css({
					'display': 'inline-block',
					'color': 'red'
				});
				showSearch('focus1');
				return false;
			}
			//关键词
			for(var i = 0; i < $("#search_keyword_box .mykeywordspc").length; i++) {
				if($("#search_keyword_box .mykeywordspc").eq(i).val() == '') {
					$("#search_keyword_box .mykeywordspc").eq(i).attr('autofocus', 'autofocus');
					$("#search_keyword_box .mykeywordspc").eq(i).siblings('span.keywords_error').text('请填写关键字');
					showSearch('focus1');
					return false;
				} else {
					$("#search_keyword_box .mykeywordspc").eq(i).siblings('span.keywords_error').text('');
				}
			}
		} else if($(".by_taobao").hasClass('search_active')) {
			//      		var imgApp = $("#img_app").val(); //淘宝app上传图片
			var imgApp = $("#img_app_tb").attr('src'); //淘宝app上传图片
			var isUpload = $("#img_app").data('img');
			if(imgApp.indexOf('maoke') > 0 && isUpload == '..') {
				$("#m_app_tb_img_error").text('请上传图片').css({
					'display': 'inline-block',
					'color': 'red'
				});
				showSearch('focus2');
				return false;
			}

			if($(".goods_keywords").children('h2').hasClass('actived')) {
				//关键词

				for(var i = 0; i < $("#search_keyword_box_taobao .mykeywordsapp").length; i++) {
					if($("#search_keyword_box_taobao .mykeywordsapp").eq(i).val() == '') {
						$("#search_keyword_box_taobao .mykeywordsapp").eq(i).siblings('span.keywords_error').text('请填写关键字');
						showSearch('focus2');
						return false;
					} else {
						$("#search_keyword_box_taobao .mykeywordsapp").eq(i).siblings('span.keywords_error').text('');
					}
				}
			} else if($(".goods_taokouling").children('h2').hasClass('actived')) {
				//淘口令

				for(var i = 0; i < $(".taokouling_pannel>.taokouling_box .iphone_tb_command").length; i++) {
					if($(".taokouling_pannel>.taokouling_box .iphone_tb_command").eq(i).val() == '') {
						$(".taokouling_pannel>.taokouling_box .iphone_tb_command").eq(i).siblings('p').find('i').text('淘口令不能为空').show();

						return false;
					} else {
						$(".taokouling_pannel>.taokouling_box .iphone_tb_command").eq(i).siblings('p').find('i').text('');
					}
				}
			} else {
				$("#no_choose_tips").show();
				return false;
			}

		} else {
			alert('请选择发布平台');
			return false;
		}
        $('#myform').submit();
		//window.location.href='{:U(\'publishthird\')}'
	}
</script>
<script src="__PUBLIC__/ajaxfileupload.js"></script>
<include file="Layout:foot" />